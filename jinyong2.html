<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title></title>

</head>

<style type="text/css">
    div {
        margin: 80 80;
        }
    svg {
        border-radius: 3px;
        border: 1px solid rgba(0,0,0,.1);
        background-color:#95A5A6;       
        }
    .nodetext {
	    font-size: 12px ;
	    font-family: SimSun;
	    fill:#000000;
        }

    .linetext {
	    font-size: 12px ;
	    font-family: SimSun;
	    fill:#3498DB;
	    fill-opacity:1.0;
        }
    .time {
        font-size: 15px;
        fill: #515A5A;
        }
	.origin-dest-line {
  		stroke: #515A5A;
 		stroke-width: 4;
		}
	.origin-text, .dest-text {
  		font-size: 14px;
  		fill: #D5D8DC;
		}
	.origin-dot, .dest-dot {
  		fill: #515A5A;
		}

</style>

<body>
    <div>
    <svg id="svg1" width="50%" height="400">
    	<image xlink:href="b2.jpg" x="0" y="-150" height="200%" width="200%"/>
    </svg>
    <svg id="svg2" width="49%" height="400">
    	<image xlink:href="b2.jpg" x="0" y="-150" height="200%" width="200%"/>
     </svg>
    <svg id="svg3" width="99.5%" height="200">
    	<image xlink:href="b3.jpg" x="-2700" y="0" height="500%" width="500%"/>
         <text class="time" x="650" y="30" text-anchor="middle">时间轴</text>
         <text class="origin-text" x="90" y="104" text-anchor="end">南宋</text>
  		 <text class="dest-text" x="1220" y="104" text-anchor="start">明</text>
 		 <circle class="origin-dot" r="5" cx="100" cy="100" />
 		 <circle class="dest-dot" r="5" cx="1210" cy="100" />
 		 <line class="origin-dest-line" x1="110" y1="100" x2="1200" y2="100" />
    </svg>
    </div>
</body>

<script src="http://d3js.org/d3.v3.min.js"></script>
<script>
	var svg1 = d3.select("body").select("#svg1");
	var svg2 = d3.select("body").select("#svg2");
	var svg3 = d3.select("body").select("#svg3");

	var timelinear = d3.scale.linear()
                        .domain([1127, 1368])
                        .range([110, 1200]);

    svg3.append("line")
    	.attr("x1",timelinear(1127))
    	.attr("y1",70)
    	.attr("x2",timelinear(1127))
    	.attr("y2",130)
    	.style("stroke","#515A5A")
    	.style("stroke-width",2);
    svg3.append("text")
	 	.text("靖康之变，南宋建立")
	 	.attr("x",timelinear(1127))
	 	.attr("y",55)
	 	.attr("text-anchor","middle")
	 	.attr("dy",10)
	 	.attr("fill","#515A5A")
	 	.style("font-size","12px")
	 	.style("font-weighe","bold");
	svg3.append("text")
	 	.text("南宋建炎元年")
	 	.attr("x",timelinear(1127))
	 	.attr("y",150)
	 	.attr("text-anchor","middle")
	 	.attr("dy",10)
	 	.attr("fill","#515A5A")
	 	.style("font-size","12px")
	 	.style("font-weighe","bold");
	svg3.append("text")
	 	.text(1127)
	 	.attr("x",timelinear(1127))
	 	.attr("y",133)
	 	.attr("text-anchor","middle")
	 	.attr("dy",10)
	 	.attr("fill","#515A5A")
	 	.style("font-size","12px")
	 	.style("font-weighe","bold");


	 svg3.append("line")
    	.attr("x1",timelinear(1208))
    	.attr("y1",70)
    	.attr("x2",timelinear(1208))
    	.attr("y2",130)
    	.style("stroke","#515A5A")
    	.style("stroke-width",2);
    svg3.append("text")
	 	.text("宋金嘉定和议")
	 	.attr("x",timelinear(1208))
	 	.attr("y",55)
	 	.attr("text-anchor","middle")
	 	.attr("dy",10)
	 	.attr("fill","#515A5A")
	 	.style("font-size","12px")
	 	.style("font-weighe","bold");
	svg3.append("text")
	 	.text("南宋嘉定元年")
	 	.attr("x",timelinear(1208))
	 	.attr("y",150)
	 	.attr("text-anchor","middle")
	 	.attr("dy",10)
	 	.attr("fill","#515A5A")
	 	.style("font-size","12px")
	 	.style("font-weighe","bold");
	svg3.append("text")
	 	.text(1208)
	 	.attr("x",timelinear(1208))
	 	.attr("y",133)
	 	.attr("text-anchor","middle")
	 	.attr("dy",10)
	 	.attr("fill","#515A5A")
	 	.style("font-size","12px")
	 	.style("font-weighe","bold");



	 svg3.append("line")
    	.attr("x1",timelinear(1227))
    	.attr("y1",70)
    	.attr("x2",timelinear(1227))
    	.attr("y2",130)
    	.style("stroke","#515A5A")
    	.style("stroke-width",2);
    svg3.append("text")
	 	.text("成吉思汗逝世")
	 	.attr("x",timelinear(1227))
	 	.attr("y",55)
	 	.attr("text-anchor","middle")
	 	.attr("dy",10)
	 	.attr("fill","#515A5A")
	 	.style("font-size","12px")
	 	.style("font-weighe","bold");
	svg3.append("text")
	 	.text("南宋宝庆三年")
	 	.attr("x",timelinear(1227))
	 	.attr("y",150)
	 	.attr("text-anchor","middle")
	 	.attr("dy",10)
	 	.attr("fill","#515A5A")
	 	.style("font-size","12px")
	 	.style("font-weighe","bold");
	svg3.append("text")
	 	.text(1227)
	 	.attr("x",timelinear(1227))
	 	.attr("y",133)
	 	.attr("text-anchor","middle")
	 	.attr("dy",10)
	 	.attr("fill","#515A5A")
	 	.style("font-size","12px")
	 	.style("font-weighe","bold");



	svg3.append("line")
    	.attr("x1",timelinear(1251))
    	.attr("y1",70)
    	.attr("x2",timelinear(1251))
    	.attr("y2",130)
    	.style("stroke","#515A5A")
    	.style("stroke-width",2);
    svg3.append("text")
	 	.text("蒙哥即蒙古大汗")
	 	.attr("x",timelinear(1251))
	 	.attr("y",55)
	 	.attr("text-anchor","middle")
	 	.attr("dy",10)
	 	.attr("fill","#515A5A")
	 	.style("font-size","12px")
	 	.style("font-weighe","bold");
	svg3.append("text")
	 	.text("南宋淳祐十一年")
	 	.attr("x",timelinear(1251))
	 	.attr("y",150)
	 	.attr("text-anchor","middle")
	 	.attr("dy",10)
	 	.attr("fill","#515A5A")
	 	.style("font-size","12px")
	 	.style("font-weighe","bold");
	svg3.append("text")
	 	.text(1251)
	 	.attr("x",timelinear(1251))
	 	.attr("y",133)
	 	.attr("text-anchor","middle")
	 	.attr("dy",10)
	 	.attr("fill","#515A5A")
	 	.style("font-size","12px")
	 	.style("font-weighe","bold");



	svg3.append("line")
    	.attr("x1",timelinear(1271))
    	.attr("y1",70)
    	.attr("x2",timelinear(1271))
    	.attr("y2",130)
    	.style("stroke","#515A5A")
    	.style("stroke-width",2);
    svg3.append("text")
	 	.text("忽必烈称帝建元")
	 	.attr("x",timelinear(1271))
	 	.attr("y",55)
	 	.attr("text-anchor","middle")
	 	.attr("dy",10)
	 	.attr("fill","#515A5A")
	 	.style("font-size","12px")
	 	.style("font-weighe","bold");
	svg3.append("text")
	 	.text("元至元八年")
	 	.attr("x",timelinear(1271))
	 	.attr("y",150)
	 	.attr("text-anchor","middle")
	 	.attr("dy",10)
	 	.attr("fill","#515A5A")
	 	.style("font-size","12px")
	 	.style("font-weighe","bold");
	svg3.append("text")
	 	.text("南宋咸淳七年")
	 	.attr("x",timelinear(1271))
	 	.attr("y",165)
	 	.attr("text-anchor","middle")
	 	.attr("dy",10)
	 	.attr("fill","#515A5A")
	 	.style("font-size","12px")
	 	.style("font-weighe","bold");
	svg3.append("text")
	 	.text(1271)
	 	.attr("x",timelinear(1271))
	 	.attr("y",133)
	 	.attr("text-anchor","middle")
	 	.attr("dy",10)
	 	.attr("fill","#515A5A")
	 	.style("font-size","12px")
	 	.style("font-weighe","bold");



	svg3.append("line")
    	.attr("x1",timelinear(1294))
    	.attr("y1",70)
    	.attr("x2",timelinear(1294))
    	.attr("y2",130)
    	.style("stroke","#515A5A")
    	.style("stroke-width",2);
    svg3.append("text")
	 	.text("忽必烈病逝")
	 	.attr("x",timelinear(1294))
	 	.attr("y",55)
	 	.attr("text-anchor","middle")
	 	.attr("dy",10)
	 	.attr("fill","#515A5A")
	 	.style("font-size","12px")
	 	.style("font-weighe","bold");
	svg3.append("text")
	 	.text("元至元三十一年")
	 	.attr("x",timelinear(1294))
	 	.attr("y",150)
	 	.attr("text-anchor","middle")
	 	.attr("dy",10)
	 	.attr("fill","#515A5A")
	 	.style("font-size","12px")
	 	.style("font-weighe","bold");
	svg3.append("text")
	 	.text(1294)
	 	.attr("x",timelinear(1294))
	 	.attr("y",133)
	 	.attr("text-anchor","middle")
	 	.attr("dy",10)
	 	.attr("fill","#515A5A")
	 	.style("font-size","12px")
	 	.style("font-weighe","bold");
	 	



	svg3.append("line")
    	.attr("x1",timelinear(1368))
    	.attr("y1",70)
    	.attr("x2",timelinear(1368))
    	.attr("y2",130)
    	.style("stroke","#515A5A")
    	.style("stroke-width",2);
    svg3.append("text")
	 	.text("朱元璋建立明朝")
	 	.attr("x",timelinear(1368))
	 	.attr("y",55)
	 	.attr("text-anchor","middle")
	 	.attr("dy",10)
	 	.attr("fill","#515A5A")
	 	.style("font-size","12px")
	 	.style("font-weighe","bold");
	svg3.append("text")
	 	.text("明洪武元年")
	 	.attr("x",timelinear(1368))
	 	.attr("y",150)
	 	.attr("text-anchor","middle")
	 	.attr("dy",10)
	 	.attr("fill","#515A5A")
	 	.style("font-size","12px")
	 	.style("font-weighe","bold");
	svg3.append("text")
	 	.text(1368)
	 	.attr("x",timelinear(1368))
	 	.attr("y",133)
	 	.attr("text-anchor","middle")
	 	.attr("dy",10)
	 	.attr("fill","#515A5A")
	 	.style("font-size","12px")
	 	.style("font-weighe","bold"); 	 	


	svg2.append("text")
		 	.text("人物生平活动范围")
		 	.attr("x",310)
		 	.attr("y",20)
		 	.attr("text-anchor","middle")
		 	.attr("dy",10)
		 	.attr("fill","#515A5A")
		 	.style("font-size","15px")
		 	.style("font-weighe","bold");

    svg1.append("text")
		 	.text("人物关系网")
		 	.attr("x",310)
		 	.attr("y",20)
		 	.attr("text-anchor","middle")
		 	.attr("dy",10)
		 	.attr("fill","#515A5A")
		 	.style("font-size","15px")
		 	.style("font-weighe","bold");

	svg2.append("text")
		 	.text("5年及以上")
		 	.attr("x",620)
		 	.attr("y",220)
		 	.attr("text-anchor","middle")
		 	.attr("dy",10)
		 	.attr("fill","#515A5A")
		 	.style("font-size","10px")
		 	.style("font-weighe","bold");  

	svg2.append("text")
		 	.text("0年")
		 	.attr("x",610)
		 	.attr("y",350)
		 	.attr("text-anchor","middle")
		 	.attr("dy",10)
		 	.attr("fill","#515A5A")
		 	.style("font-size","10px")
		 	.style("font-weighe","bold");    

	//
	//svg1 人物关系
	//

	var width = 660;
	var height = 400;
	var img_w = 40;
	var img_h = 40;

	d3.json("data.json", function(error, root1) {
		
		if (error) 
			return console.error(error);
		console.log(root1);

		var force = d3.layout.force()
							.nodes(root1.nodes)
							.links(root1.edges)
							.size([660,400])
							.linkDistance(250)
							.charge(-1500)
							.start();
							
			var edges_line = svg1.selectAll("line")
								.data(root1.edges)
								.enter()
								.append("line")
								.style("stroke","#2C3E50")
								.style("stroke-width",1);
								
			var edges_text = svg1.selectAll(".linetext")
								.data(root1.edges)
								.enter()
								.append("text")
								.attr("class","linetext")
								.text(function(d){
									return d.relation;
								});
			
								
			var nodes_img = svg1.selectAll(".svg1image")
								.data(root1.nodes)
								.enter()
								.append("image")
								.attr("class","svg1image")
								.attr("width",40)
								.attr("height",40)
								.attr("xlink:href",function(d){
									return d.image;
								})
								.on("mouseover",function(d,i){
									//显示连接线上的文字
									edges_text.style("fill-opacity",function(edge){
										if( edge.source === d || edge.target === d ){
											return 1.0;
										}
									});
								})
								.on("mouseout",function(d,i){
									//隐去连接线上的文字
									edges_text.style("fill-opacity",function(edge){
										if( edge.source === d || edge.target === d ){
											return 0.0;
										}
									});
								})
								.on("click",function(d,i){
									svg3.selectAll(".datacircle").remove();
									svg3.selectAll(".mytext").remove();
									svg2.selectAll("path").attr("fill","#FADBD8");
									svg2.selectAll(".name").remove();
									svg2.append("text")
							 			 .attr("class","name")
							 			 .text(d.name)
							 			 .attr("x",310)
							 			 .attr("y",70)
							 			 .attr("text-anchor","middle")
							 	 		.attr("dy",10)
							 	 		.attr("fill","#454545");
									life = d.life;
									console.log(life);											
								})
								//.on("click",function(d,i){
									
								//	console.log(d.year);
								//	d.year.foreach(function(d,i){d3.select("body").select("div").select("#svg3")			.append("circle")									    
								//	    .attr("cx",d)
								//	    .attr("cy",100)
								//	    .attr("r",10)		})
								.call(force.drag);
			
			 var marker=svg1.append("marker")
            			   .attr("id", "resolved")
            				.attr("markerUnits","userSpaceOnUse")
            				.attr("viewBox", "0 -5 10 10")//坐标系的区域
           					.attr("refX",34)//箭头坐标
            				.attr("refY", -1)
           					.attr("markerWidth", 8)//标识的大小
            				.attr("markerHeight", 8)
            				.attr("orient", "auto")//绘制方向，可设定为：auto（自动确认方向）和 角度值
            				.attr("stroke-width",2)//箭头宽度
            				.append("path")
            				.attr("d", "M0,-5L10,0L0,5")//箭头的路径
            				.attr('fill','#2C3E50');//箭头颜色

			var text_dx = -20;
			var text_dy = 20;
			
			var nodes_text = svg1.selectAll(".nodetext")
								.data(root1.nodes)
								.enter()
								.append("text")
								.attr("class","nodetext")
								.attr("dx",text_dx)
								.attr("dy",text_dy)
								.text(function(d){
									return d.name;
								});
			
								
			force.on("tick", function(){
				
				//限制结点的边界
				root1.nodes.forEach(function(d,i){
					d.x = d.x - img_w/2 < 0     ? img_w/2 : d.x ;
					d.x = d.x + img_w/2 > width ? width - img_w/2 : d.x ;
					d.y = d.y - img_h/2 < 0      ? img_h/2 : d.y ;
					d.y = d.y + img_h/2 + text_dy > height ? height - img_h/2 - text_dy : d.y ;
				});
			
				//更新连接线的位置
				 edges_line.attr("x1",function(d){ return d.source.x; });
				 edges_line.attr("y1",function(d){ return d.source.y; });
				 edges_line.attr("x2",function(d){ return d.target.x; });
				 edges_line.attr("y2",function(d){ return d.target.y; });
				 edges_line.attr("marker-end", "url(#resolved)");
				 
				 //更新连接线上文字的位置
				 edges_text.attr("x",function(d){ return (d.source.x + d.target.x) / 2 ; });
				 edges_text.attr("y",function(d){ return (d.source.y + d.target.y) / 2 ; });
				 
				 
				 //更新结点图片和文字
				 nodes_img.attr("x",function(d){ return d.x - img_w/2; });
				 nodes_img.attr("y",function(d){ return d.y - img_h/2; });
				 
				 nodes_text.attr("x",function(d){ return d.x });
				 nodes_text.attr("y",function(d){ return d.y + img_w/2; });
			});
		});



	//
	//svg2 地图
	//

	var projection = d3.geo.equirectangular()
						.center([107, 31])
						.scale(550)
    					.translate([350, 245]);
	
	var path = d3.geo.path()
					.projection(projection);
	
	
	var color = d3.scale.category20();
	
	
	d3.json("china.geojson", function(error, root) {
		
		if (error) 
			return console.error(error);
		console.log(root);
		
		svg2.selectAll("path")
			.data( root.features )
			.enter()
			.append("path")
			.attr("class",function(d,i){return d.properties.name})
			.attr("stroke","#273746")
			.attr("stroke-width",0.3)
			.attr("fill", function(d,i){
				return "#FADBD8";
			})
			.attr("d", path )
			.on("mouseover",function(d,i){
                d3.select(this)
                    .attr("fill","#fff");
            })
            .on("mouseout",function(d,i){
                d3.select(this)
                    .attr("fill","#FADBD8");
            });        
        });

	var colorlinear = d3.scale.linear()
                        .domain([0, 5])
                        .range([0, 1]);
 
        //定义最小值和最大值对应的颜色
    var a = d3.rgb(250, 219, 216);  //浅灰色
    var b = d3.rgb(176, 58, 46);    //灰色
         
        //颜色插值函数
    var mapColor = d3.interpolate(a,b);



 	//颜色渐变
    var defs = svg2.append("defs");

	var linearGradient = defs.append("linearGradient")
						.attr("id","linearColor")
						.attr("x1","0%")
						.attr("y1","100%")
						.attr("x2","0%")
						.attr("y2","0%");

	var stop1 = linearGradient.append("stop")
				.attr("offset","0%")
				.style("stop-color","#FADBD8");

	var stop2 = linearGradient.append("stop")
				.attr("offset","100%")
				.style("stop-color","#B03A2E");

	//添加一个矩形，并应用线性渐变
	var colorRect = svg2.append("rect")
				.attr("x", 570)
				.attr("y", 220)
				.attr("width", 20)
				.attr("height", 140)
				.style("fill","url(#" + linearGradient.attr("id") + ")");
				
	//svg2.append("path")
    //           .datum({type: "LineString", coordinates: [[104,37], [108,36]]})
    //           .attr("class", "route")
    //           .attr("d", path)
    //           .attr("stroke","red");
    //
	//svg3 时间轴
	//
	var life = [];
    setInterval("circle();",100);
	 function circle(){
		svg3.selectAll(".datacircle")
	 	 .data(life)
	 	 .enter()
	 	 .append("circle")
	 	 .attr("class","datacircle")
	 	 .attr("cx",function(d,i){return timelinear(d.year)})
	 	 .attr("cy",100)
	 	 .attr("r",6)
	 	 .attr("fill","#D5D8DC")
	 	 .on("mouseover",function(d,i){
	 	 	d3.select(this).attr("fill","#F1948A");
		 	svg3.append("text")
			 	 .attr("class","mytext")
			 	 .text(d.year)
			 	 .attr("x",timelinear(d.year))
			 	 .attr("y",115)
			 	 .attr("text-anchor","middle")
			 	 .attr("dy",10)
			 	 .attr("fill","#D5D8DC")
	 	 })
	 	 .on("click",function(d,i){
	 	 	d3.select(this).attr("fill","#F1948A");
	 	 	svg2.append("circle")
    			.attr("class","location")
    			.attr("cx",projection(d.location.sort())[0])
    			.attr("cy",projection(d.location.sort())[1])
    			.attr("r",5)
    			.attr("fill","#454545");
    		svg2.append("text")
	 			 .attr("class","locationdes")
	 			 .text(d.locationdes)
	 			 .attr("x",projection(d.location.sort())[0])
	 			 .attr("y",projection(d.location.sort())[1] - 20)
	 			 .attr("text-anchor","middle")
	 	 		.attr("dy",10)
	 	 		.attr("fill","#454545");
	 	 	svg2.select(d.spot)
	 	 		.attr("fill","#fff");	


	 	 	svg1.append("image")
         	   .attr("class","thingimage")
	           .attr("x",0)
	           .attr("y",-150)
	    	   .attr("width","300%")
	    	   .attr("height","300%")
	    	   .attr("xlink:href","b2.jpg");

	 	 	svg1.append("image")
         	   .attr("class","thingimage")
	           .attr("x",300)
	           .attr("y",200)
	    	   .attr("width",0)
	    	   .attr("height",0)
	    	   .attr("xlink:href",d.thingimage)
	    	   .transition()
               .duration(500)
               .attr("x",80)
	           .attr("y",30)
	    	   .attr("width",500)
	    	   .attr("height",300);
	    	svg1.append("text")
	 			 .attr("class","des")
	 			 .text(d.des)
	 			 .attr("x",340)
	 			 .attr("y",360)
	 			 .attr("text-anchor","middle")
	 	 		.attr("dy",10)
	 	 		.attr("fill","#454545");
	 	 })
	 	 .on("mouseout",function(d,i){
	 	 	svg3.selectAll(".datacircle").attr("fill","#D5D8DC");
	 	 	svg1.selectAll(".thingimage").remove();
	 	 	svg2.selectAll(".location").remove();
	 	 	svg2.selectAll(".locationdes").remove();
	 	 	svg1.selectAll(".des").remove();
	 	 	svg3.selectAll(".mytext").remove();
	 	 });
	 	

	 	


	 	life.forEach((d,i)=>{
	 		svg2.select(d.spot)
	 			.attr("fill",mapColor(colorlinear(d.value)))
	 	})
	 	};
	
    
    
</script>
</html>